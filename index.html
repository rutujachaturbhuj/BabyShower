<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rutuja & Tanmay ‚Äî Baby Shower Quiz</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Jost:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#fdf6f0; --card:#fff; --border:#f0ddd4;
    --accent:#e8a598; --accent3:#d4afc8;
    --text:#3a2f2f; --muted:#a08c88;
    --rutuja:#e8a598; --tanmay:#8db3a8;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:'Jost',sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;
    background-image:radial-gradient(ellipse at 10% 10%,rgba(232,165,152,.18) 0%,transparent 50%),
    radial-gradient(ellipse at 90% 90%,rgba(181,201,191,.2) 0%,transparent 50%),
    radial-gradient(ellipse at 80% 10%,rgba(212,175,200,.15) 0%,transparent 40%)}
  .quiz-wrap{width:100%;max-width:660px}
  .deco{position:fixed;font-size:1.5rem;opacity:.18;pointer-events:none;animation:float 6s ease-in-out infinite}
  .deco:nth-child(1){top:8%;left:5%} .deco:nth-child(2){top:15%;right:8%;animation-delay:1s;font-size:1.1rem}
  .deco:nth-child(3){bottom:20%;left:7%;animation-delay:2s;font-size:1.2rem} .deco:nth-child(4){bottom:10%;right:5%;animation-delay:.5s}
  .deco:nth-child(5){top:45%;left:2%;animation-delay:1.5s;font-size:1rem} .deco:nth-child(6){top:50%;right:3%;animation-delay:2.5s;font-size:.9rem}
  @keyframes float{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-12px) rotate(5deg)}}
  @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
  @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* INTRO */
  #intro{text-align:center;animation:fadeUp .7s ease both}
  .baby-icon{font-size:3rem;margin-bottom:1rem;display:block;animation:bounce 2s ease-in-out infinite}
  .eyebrow{font-size:.72rem;letter-spacing:.3em;text-transform:uppercase;color:var(--muted);margin-bottom:1rem}
  h1{font-family:'Cormorant Garamond',serif;font-size:clamp(2rem,6vw,3rem);line-height:1.15;margin-bottom:.5rem}
  h1 em{font-style:italic;color:var(--accent)}
  .subtitle{color:var(--muted);font-size:.92rem;font-weight:300;margin-bottom:2rem;line-height:1.6}
  .couple-preview{display:flex;align-items:center;justify-content:center;gap:1.5rem;margin-bottom:2rem}
  .name-pill{padding:.5rem 1.4rem;border-radius:50px;font-size:.9rem;font-weight:500}
  .pill-r{background:rgba(232,165,152,.2);color:var(--rutuja);border:1.5px solid rgba(232,165,152,.4)}
  .pill-t{background:rgba(141,179,168,.2);color:var(--tanmay);border:1.5px solid rgba(141,179,168,.4)}
  .or-badge{font-family:'Cormorant Garamond',serif;font-style:italic;font-size:1.1rem;color:var(--muted)}
  .name-input-wrap{margin-bottom:2rem}
  .name-label{display:block;font-size:.75rem;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-bottom:.6rem}
  .name-input{width:100%;max-width:320px;padding:.85rem 1.2rem;border:1.5px solid var(--border);border-radius:50px;background:var(--card);color:var(--text);font-family:'Jost',sans-serif;font-size:.95rem;text-align:center;outline:none;transition:border-color .2s,box-shadow .2s}
  .name-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(232,165,152,.15)}
  .name-input::placeholder{color:#cdbfbb}
  .input-error{color:#e07070;font-size:.78rem;margin-top:.5rem;display:none}

  .intro-outline{background:transparent;border:1.5px solid var(--border);color:var(--muted);padding:.75rem 2rem;border-radius:50px;font-family:'Jost',sans-serif;font-size:.88rem;cursor:pointer;transition:all .2s}
  .intro-outline:hover{border-color:var(--accent);color:var(--accent)}
  .btn{background:var(--accent);color:#fff;border:none;padding:.9rem 2.8rem;border-radius:50px;font-family:'Jost',sans-serif;font-weight:500;font-size:.9rem;letter-spacing:.08em;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 4px 20px rgba(232,165,152,.35)}
  .btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(232,165,152,.45)}

  /* QUIZ */
  #quiz{display:none}
  .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;animation:fadeUp .4s ease both}
  .q-counter{font-size:.75rem;letter-spacing:.2em;text-transform:uppercase;color:var(--muted)}
  .score-pill{background:rgba(232,165,152,.15);border:1px solid rgba(232,165,152,.3);color:var(--accent);font-size:.75rem;padding:.25rem .8rem;border-radius:50px}
  .progress-bar{width:100%;height:4px;background:var(--border);margin-bottom:2rem;border-radius:4px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--rutuja),var(--accent3),var(--tanmay));border-radius:4px;transition:width .5s cubic-bezier(.4,0,.2,1)}
  .question-card{background:var(--card);border:1.5px solid var(--border);border-radius:20px;padding:2.2rem 2rem;margin-bottom:1.2rem;box-shadow:0 4px 30px rgba(160,120,110,.08);animation:fadeUp .4s ease both}
  .q-number{font-size:.72rem;letter-spacing:.2em;text-transform:uppercase;color:var(--accent);margin-bottom:.75rem;font-weight:500}
  .question-text{font-family:'Cormorant Garamond',serif;font-size:1.45rem;line-height:1.4;margin-bottom:1.8rem}
  .options{display:grid;grid-template-columns:1fr 1fr;gap:.9rem}
  .option{border:1.5px solid var(--border);border-radius:14px;color:var(--text);padding:1.1rem 1rem;text-align:center;cursor:pointer;font-family:'Jost',sans-serif;font-size:.88rem;font-weight:400;transition:all .2s;background:var(--bg);display:flex;flex-direction:column;align-items:center;gap:.4rem}
  .option-emoji{font-size:1.5rem}
  .option:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 6px 20px rgba(160,120,110,.12)}
  .option.rutuja-hover:hover:not(:disabled){border-color:var(--rutuja);background:rgba(232,165,152,.08)}
  .option.tanmay-hover:hover:not(:disabled){border-color:var(--tanmay);background:rgba(141,179,168,.08)}
  .option.selected-r{border-color:var(--rutuja);background:rgba(232,165,152,.12);color:#c4736a;font-weight:500}
  .option.selected-t{border-color:var(--tanmay);background:rgba(141,179,168,.12);color:#5a9187;font-weight:500}
  .option:disabled{cursor:default}
  .nav-row{display:flex;justify-content:center;margin-top:.5rem}

  /* RESULTS */
  #results{display:none;animation:fadeUp .6s ease both}
  .result-top{text-align:center;margin-bottom:1.5rem}
  .result-big{font-size:3rem;margin-bottom:.4rem}
  .player-greeting{font-size:.8rem;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-bottom:.4rem}
  .result-title{font-family:'Cormorant Garamond',serif;font-size:2rem;margin-bottom:.4rem}
  .result-sub{color:var(--muted);font-size:.9rem;font-weight:300;margin-bottom:1rem}

  .score-summary-card{background:var(--card);border:1.5px solid var(--border);border-radius:18px;padding:1.4rem 1.8rem;margin-bottom:1.2rem;box-shadow:0 4px 20px rgba(160,120,110,.07);text-align:center}
  .score-summary-label{font-size:.72rem;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-bottom:.4rem}
  .score-summary-num{font-family:'Cormorant Garamond',serif;font-size:2.2rem;color:var(--accent);line-height:1;margin-bottom:1rem}
  .score-bar-track{display:flex;height:10px;border-radius:50px;overflow:hidden;background:var(--border);margin-bottom:.5rem}
  .score-bar-r{background:var(--rutuja);transition:width 1s cubic-bezier(.4,0,.2,1)}
  .score-bar-t{background:var(--tanmay);transition:width 1s cubic-bezier(.4,0,.2,1) .1s}
  .score-bar-legend{display:flex;justify-content:space-between;font-size:.72rem;margin-top:.5rem}
  .legend-r{color:var(--rutuja);font-weight:500} .legend-t{color:var(--tanmay);font-weight:500}

  .tally-cards{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.2rem}
  .tally-card{border-radius:18px;padding:1.3rem;text-align:center}
  .tally-card.rutuja-card{background:rgba(232,165,152,.12);border:1.5px solid rgba(232,165,152,.3)}
  .tally-card.tanmay-card{background:rgba(141,179,168,.12);border:1.5px solid rgba(141,179,168,.3)}
  .tally-name{font-size:.72rem;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-bottom:.4rem}
  .tally-num{font-family:'Cormorant Garamond',serif;font-size:2.8rem;line-height:1;margin-bottom:.2rem}
  .tally-card.rutuja-card .tally-num{color:var(--rutuja)}
  .tally-card.tanmay-card .tally-num{color:var(--tanmay)}
  .tally-label{font-size:.75rem;color:var(--muted);font-weight:300}
  .tally-sub{font-size:.68rem;color:var(--muted);margin-top:.3rem}

  /* Poll */
  .poll-section{margin-bottom:1.5rem}
  .poll-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
  .poll-title{font-size:.72rem;letter-spacing:.2em;text-transform:uppercase;color:var(--muted)}
  .poll-voters{font-size:.72rem;color:var(--muted);background:rgba(232,165,152,.12);padding:.2rem .7rem;border-radius:50px;border:1px solid rgba(232,165,152,.25)}
  .poll-loading{text-align:center;color:var(--muted);font-size:.85rem;padding:2rem;display:flex;align-items:center;justify-content:center;gap:.6rem}
  .spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
  .poll-card{background:var(--card);border:1.5px solid var(--border);border-radius:16px;padding:1.2rem 1.5rem;margin-bottom:.8rem;box-shadow:0 2px 12px rgba(160,120,110,.06)}
  .poll-question{font-family:'Cormorant Garamond',serif;font-size:1.05rem;margin-bottom:1rem;line-height:1.4}
  .poll-bar-row{display:flex;flex-direction:column;gap:.5rem}
  .poll-bar-item{display:flex;align-items:center;gap:.7rem;font-size:.82rem}
  .poll-bar-label{width:52px;font-weight:500;flex-shrink:0}
  .poll-bar-label.label-r{color:#c4736a} .poll-bar-label.label-t{color:#5a9187}
  .poll-bar-track2{flex:1;height:8px;background:var(--border);border-radius:50px;overflow:hidden}
  .poll-bar-fill{height:100%;border-radius:50px;transition:width .9s cubic-bezier(.4,0,.2,1);width:0%}
  .fill-r{background:var(--rutuja)} .fill-t{background:var(--tanmay)}
  .poll-bar-pct{width:32px;text-align:right;color:var(--muted);font-size:.75rem;flex-shrink:0}
  .poll-meta{font-size:.7rem;color:var(--muted);margin-top:.6rem;font-style:italic;display:flex;gap:.4rem;flex-wrap:wrap;align-items:center}
  .pick-r{color:#c4736a;font-style:normal;font-weight:500} .pick-t{color:#5a9187;font-style:normal;font-weight:500}
  .winner-tag{background:rgba(232,165,152,.12);border:1px solid rgba(232,165,152,.3);color:#c4736a;font-size:.68rem;padding:.15rem .5rem;border-radius:50px;font-style:normal;font-weight:500}
  .winner-tag.wt{background:rgba(141,179,168,.12);border-color:rgba(141,179,168,.3);color:#5a9187}
  .poll-error{text-align:center;color:#e07070;font-size:.82rem;padding:1.5rem;background:rgba(224,112,112,.05);border:1px solid rgba(224,112,112,.2);border-radius:12px}

  .result-actions{display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;margin-top:1rem}
  .btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--muted);padding:.8rem 2rem;border-radius:50px;font-family:'Jost',sans-serif;font-size:.88rem;cursor:pointer;transition:all .2s}
  .btn-outline:hover{border-color:var(--accent);color:var(--accent)}
</style>
</head>
<body>

<div class="deco">üçº</div><div class="deco">‚≠ê</div><div class="deco">üå∏</div>
<div class="deco">üíõ</div><div class="deco">üåô</div><div class="deco">üê£</div>

<div class="quiz-wrap">

  <!-- INTRO -->
  <div id="intro">
    <span class="baby-icon">üë∂</span>
    <p class="eyebrow">Baby Shower Quiz</p>
    <h1>Who's More Likely?<br><em>Rutuja & Tanmay</em></h1>
    <p class="subtitle">10 questions about the parents-to-be.<br>Vote &amp; see how all guests compare after!</p>
    <div class="couple-preview">
      <span class="name-pill pill-r">Rutuja</span>
      <span class="or-badge">or</span>
      <span class="name-pill pill-t">Tanmay</span>
    </div>
    <div class="name-input-wrap">
      <label class="name-label" for="player-name">Your Name</label>
      <input class="name-input" id="player-name" type="text" placeholder="Enter your name..." maxlength="30"/>
      <div class="input-error" id="name-error">Please enter your name to continue!</div>
    </div>
    <button class="btn" onclick="startQuiz()">Let's Play üéâ</button>
    <br><br>
    <button class="intro-outline" onclick="viewResultsOnly()">üìä View Guest Poll Results</button>
  </div>

  <!-- QUIZ -->
  <div id="quiz">
    <div class="question-header">
      <span class="q-counter" id="q-counter">Question 1 of 10</span>
      <span class="score-pill" id="score-live">Rutuja: 0 ¬∑ Tanmay: 0</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progress" style="width:0%"></div></div>
    <div class="question-card">
      <div class="q-number" id="q-number">01 / 10</div>
      <div class="question-text" id="q-text"></div>
      <div class="options" id="options"></div>
    </div>
    <div class="nav-row">
      <button class="btn" id="next-btn" onclick="nextQuestion()" style="display:none">Next ‚Üí</button>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="results">
    <div class="result-top">
      <div class="result-big">üéä</div>
      <div class="player-greeting" id="player-greeting"></div>
      <div class="result-title" id="result-title"></div>
      <div class="result-sub" id="result-sub"></div>
    </div>

    <div class="score-summary-card">
      <div class="score-summary-label">Your Votes</div>
      <div class="score-summary-num" id="score-summary-num"></div>
      <div class="score-bar-track">
        <div class="score-bar-r" id="score-bar-r" style="width:0%"></div>
        <div class="score-bar-t" id="score-bar-t" style="width:0%"></div>
      </div>
      <div class="score-bar-legend">
        <span class="legend-r">Rutuja</span>
        <span class="legend-t">Tanmay</span>
      </div>
    </div>

    <div class="tally-cards">
      <div class="tally-card rutuja-card">
        <div class="tally-name">Rutuja</div>
        <div class="tally-num" id="r-total">‚Äî</div>
        <div class="tally-label">total votes</div>
        <div class="tally-sub" id="r-total-sub"></div>
      </div>
      <div class="tally-card tanmay-card">
        <div class="tally-name">Tanmay</div>
        <div class="tally-num" id="t-total">‚Äî</div>
        <div class="tally-label">total votes</div>
        <div class="tally-sub" id="t-total-sub"></div>
      </div>
    </div>

    <div class="poll-section">
      <div class="poll-header">
        <span class="poll-title">Guest Poll ‚Äî Per Question</span>
        <span class="poll-voters" id="poll-voters">Loading...</span>
      </div>
      <div id="poll-cards">
        <div class="poll-loading"><div class="spinner"></div> Fetching guest responses...</div>
      </div>
    </div>

    <div class="result-actions">
      <button class="btn-outline" onclick="location.reload()">Play Again</button>
      <button class="btn" onclick="shareResult()">Share Results üíå</button>
    </div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ PASTE YOUR GOOGLE APPS SCRIPT URL HERE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// After deploying, replace the empty string below with your URL
// e.g. "https://script.google.com/macros/s/ABC123/exec"
let SCRIPT_URL = localStorage.getItem('babyquiz-script-url') || "https://script.google.com/macros/s/AKfycbyj6q0eqir2Xzf6LGppkK3m58dOS-4yBPKz3L1iLsw5Lxn-epx-WeMdZy9n-veVQUrQ/exec";
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const questions = [
  { q:"Who is more likely to be the stricter parent?",               emojis:["üë©‚Äç‚öñÔ∏è","üë®‚Äç‚öñÔ∏è"] },
  { q:"Who will be responsible for the most diaper changes?",        emojis:["üôã‚Äç‚ôÄÔ∏è","üôã‚Äç‚ôÇÔ∏è"] },
  { q:"Who will be the first to cry at the baby milestones?",        emojis:["üò≠","üò≠"]    },
  { q:"Who will be more likely to take a million photos of the baby?",emojis:["üì∏","üì∑"]   },
  { q:"Who will be better at calming the baby?",                     emojis:["ü§±","üë®‚Äçüçº"]  },
  { q:"Who is more likely to wake up for midnight feedings?",         emojis:["üåô","‚≠ê"]   },
  { q:"Who will be the 'fun' parent?",                               emojis:["üéâ","üéà"]   },
  { q:"Who is more likely to baby-proof the entire house?",           emojis:["üîí","üõ°Ô∏è"]  },
  { q:"Who suggested the baby's name?",                              emojis:["üí°","‚ú®"]   },
  { q:"Who is more likely to be found singing lullabies?",           emojis:["üéµ","üé∂"]   },
];

let current=0, rScore=0, tScore=0, userAnswers=[], playerName='';

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('player-name').addEventListener('keydown', e => {
    if (e.key === 'Enter') startQuiz();
  });
});

function startQuiz() {
  playerName = document.getElementById('player-name').value.trim();
  if (!playerName) {
    document.getElementById('name-error').style.display = 'block';
    document.getElementById('player-name').focus(); return;
  }
  document.getElementById('name-error').style.display = 'none';
  document.getElementById('intro').style.display = 'none';
  document.getElementById('quiz').style.display = 'block';
  loadQuestion();
}

function loadQuestion() {
  const q = questions[current];
  document.getElementById('q-counter').textContent  = 'Question '+(current+1)+' of '+questions.length;
  document.getElementById('q-number').textContent   = String(current+1).padStart(2,'0')+' / '+questions.length;
  document.getElementById('q-text').textContent     = q.q;
  document.getElementById('progress').style.width   = ((current/questions.length)*100)+'%';
  document.getElementById('next-btn').style.display = 'none';
  document.getElementById('score-live').textContent = 'Rutuja: '+rScore+' ¬∑ Tanmay: '+tScore;

  const el = document.getElementById('options');
  el.innerHTML = '';
  const rBtn = document.createElement('button');
  rBtn.className = 'option rutuja-hover';
  rBtn.innerHTML = '<span class="option-emoji">'+q.emojis[0]+'</span>Rutuja';
  const tBtn = document.createElement('button');
  tBtn.className = 'option tanmay-hover';
  tBtn.innerHTML = '<span class="option-emoji">'+q.emojis[1]+'</span>Tanmay';
  rBtn.onclick = () => pick('rutuja', rBtn, tBtn);
  tBtn.onclick = () => pick('tanmay', rBtn, tBtn);
  el.appendChild(rBtn); el.appendChild(tBtn);

  const card = document.querySelector('.question-card');
  card.style.animation = 'none'; card.offsetHeight; card.style.animation = '';
}

function pick(choice, rBtn, tBtn) {
  rBtn.disabled = tBtn.disabled = true;
  if (choice==='rutuja') { rBtn.classList.add('selected-r'); rScore++; }
  else                   { tBtn.classList.add('selected-t'); tScore++; }
  userAnswers.push(choice);
  document.getElementById('score-live').textContent = 'Rutuja: '+rScore+' ¬∑ Tanmay: '+tScore;
  const nb = document.getElementById('next-btn');
  nb.style.display = 'block';
  nb.textContent = current < questions.length-1 ? 'Next ‚Üí' : 'See Results üéä';
}

function nextQuestion() {
  current++;
  current < questions.length ? loadQuestion() : showResults();
}

async function showResults() {
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('results').style.display = 'block';

  // Show personal summary immediately ‚Äî don't wait for poll
  document.getElementById('player-greeting').textContent   = playerName+"'s Results";
  document.getElementById('score-summary-num').textContent = rScore+' Rutuja ¬∑ '+tScore+' Tanmay';
  document.getElementById('result-title').textContent =
    rScore>tScore ? 'Rutuja takes the crown! üëë' :
    tScore>rScore ? 'Tanmay steals the show! üëë' : "It's a perfect tie! ü§ù";
  document.getElementById('result-sub').textContent =
    rScore>tScore ? playerName+' thinks Rutuja will be the MVP parent with '+rScore+'/10 votes!' :
    tScore>rScore ? playerName+' thinks Tanmay will be the MVP parent with '+tScore+'/10 votes!' :
                    playerName+" thinks they'll be equal partners ‚Äî lucky baby!";

  setTimeout(() => {
    document.getElementById('score-bar-r').style.width = ((rScore/questions.length)*100)+'%';
    document.getElementById('score-bar-t').style.width = ((tScore/questions.length)*100)+'%';
  }, 200);

  // Load poll in background ‚Äî page is already visible above
  saveAndLoadPoll();
}

// ‚îÄ‚îÄ JSONP helper ‚Äî avoids CORS entirely ‚îÄ‚îÄ
function jsonpFetch(url, timeoutMs=12000) {
  return new Promise((resolve, reject) => {
    const cbName = '_cb_' + Date.now();
    const script  = document.createElement('script');
    let   done    = false;

    const cleanup = () => {
      done = true;
      delete window[cbName];
      if (script.parentNode) script.parentNode.removeChild(script);
    };

    window[cbName] = (data) => { cleanup(); resolve(data); };

    script.onerror = () => { cleanup(); reject(new Error('Script load error')); };
    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName + '&t=' + Date.now();
    document.head.appendChild(script);

    setTimeout(() => {
      if (!done) { cleanup(); reject(new Error('Timeout')); }
    }, timeoutMs);
  });
}

async function saveAndLoadPoll() {
  const container = document.getElementById('poll-cards');

  if (!SCRIPT_URL) {
    container.innerHTML = '<div class="poll-error">‚öôÔ∏è No Google Sheet connected yet.</div>';
    document.getElementById('poll-voters').textContent = 'Not connected';
    document.getElementById('r-total').textContent = '‚Äî';
    document.getElementById('t-total').textContent = '‚Äî';
    return;
  }

  // Fire POST without awaiting ‚Äî no-cors responses are always opaque anyway
  fetch(SCRIPT_URL, {
    method: 'POST',
    mode: 'no-cors',
    body: JSON.stringify({ name: playerName, answers: userAnswers }),
    headers: { 'Content-Type': 'text/plain' }
  }).catch(e => console.warn('Save failed:', e));

  // Wait 2.5s to give Google time to write the row, then fetch results
  await new Promise(r => setTimeout(r, 2500));
  await fetchAndRenderPoll(false);
}

async function fetchAndRenderPoll(viewOnly, isRetry=false) {
  const container = document.getElementById('poll-cards');
  container.innerHTML = '<div class="poll-loading"><div class="spinner"></div> ' + (isRetry ? 'Retrying...' : 'Fetching guest responses...') + '</div>';

  try {
    const data = await jsonpFetch(SCRIPT_URL);
    renderPoll(data, viewOnly);
  } catch(e) {
    console.warn('Poll load failed:', e);
    if (!isRetry) {
      // Auto-retry once after 2s
      setTimeout(() => fetchAndRenderPoll(viewOnly, true), 2000);
    } else {
      container.innerHTML =
        '<div class="poll-error">‚ö†Ô∏è Could not load poll results.<br><small>' + e.message + '</small><br><br>' +
        '<button onclick="fetchAndRenderPoll(' + viewOnly + ')" style="margin-top:.5rem;padding:.5rem 1.2rem;border-radius:50px;border:1.5px solid #e8a598;background:transparent;color:#e8a598;cursor:pointer;font-family:Jost,sans-serif">Retry</button></div>';
    }
  }
}

function renderPoll(data, viewOnly=false) {
  const { guests=[], counts=[] } = data;
  const n = guests.length;
  let totalR=0, totalT=0;
  counts.forEach(c => { totalR+=c.rutuja; totalT+=c.tanmay; });

  document.getElementById('r-total').textContent     = totalR;
  document.getElementById('t-total').textContent     = totalT;
  document.getElementById('r-total-sub').textContent = 'across '+n+' guest'+(n!==1?'s':'');
  document.getElementById('t-total-sub').textContent = 'across '+n+' guest'+(n!==1?'s':'');
  document.getElementById('poll-voters').textContent  = n+' guest'+(n!==1?'s':'')+' voted';

  const container = document.getElementById('poll-cards');
  container.innerHTML = '';

  questions.forEach((q, i) => {
    const c = counts[i] || { rutuja:0, tanmay:0 };
    const rc=c.rutuja, tc=c.tanmay, tot=rc+tc||1;
    const rPct=Math.round((rc/tot)*100), tPct=100-rPct;
    const myPick = userAnswers[i];
    const leader = rc>tc ? 'Rutuja' : tc>rc ? 'Tanmay' : null;

    const card = document.createElement('div');
    card.className = 'poll-card';
    card.innerHTML =
      '<div class="poll-question">'+(i+1)+'. '+q.q+'</div>'+
      '<div class="poll-bar-row">'+
        '<div class="poll-bar-item">'+
          '<span class="poll-bar-label label-r">Rutuja</span>'+
          '<div class="poll-bar-track2"><div class="poll-bar-fill fill-r" data-w="'+rPct+'%"></div></div>'+
          '<span class="poll-bar-pct">'+rPct+'%</span>'+
        '</div>'+
        '<div class="poll-bar-item">'+
          '<span class="poll-bar-label label-t">Tanmay</span>'+
          '<div class="poll-bar-track2"><div class="poll-bar-fill fill-t" data-w="'+tPct+'%"></div></div>'+
          '<span class="poll-bar-pct">'+tPct+'%</span>'+
        '</div>'+
      '</div>'+
      '<div class="poll-meta"'+( viewOnly ? ' style="display:none"' : '')+'>'+
        'Your pick: <span class="'+(myPick==='rutuja'?'pick-r':'pick-t')+'">'+(myPick==='rutuja'?'Rutuja':'Tanmay')+'</span>'+
        (leader
          ? ' &nbsp;¬∑&nbsp; Most guests: <span class="winner-tag'+(leader==='Tanmay'?' wt':'')+'">' +leader+'</span>'
          : ' &nbsp;¬∑&nbsp; Tied!')+
        ' &nbsp;¬∑&nbsp; '+(rc+tc)+' vote'+((rc+tc)!==1?'s':'')+
      '</div>';
    container.appendChild(card);
  });

  setTimeout(() => {
    container.querySelectorAll('.poll-bar-fill').forEach(b => { b.style.width = b.dataset.w; });
  }, 100);
}

function viewResultsOnly() {
  document.getElementById('intro').style.display = 'none';
  document.getElementById('results').style.display = 'block';

  document.getElementById('player-greeting').textContent = 'Live Guest Poll';
  document.getElementById('result-title').textContent    = 'How guests are voting üìä';
  document.getElementById('result-sub').textContent      = 'Results update as more guests complete the quiz.';
  document.getElementById('result-big').textContent      = 'üìä';
  document.querySelector('.score-summary-card').style.display = 'none';

  userAnswers = Array(questions.length).fill(null);

  // Debug: show what URL we're using
  const container = document.getElementById('poll-cards');
  container.innerHTML = '<div class="poll-loading"><div class="spinner"></div> Connecting to Google Sheet...</div>';
  document.getElementById('poll-voters').textContent = 'Checking...';

  console.log('SCRIPT_URL:', SCRIPT_URL);

  if (!SCRIPT_URL || SCRIPT_URL.trim() === '') {
    container.innerHTML = '<div class="poll-error">‚ùå SCRIPT_URL is empty. URL not found in file.</div>';
    return;
  }

  // Show URL being used (first 60 chars)
  document.getElementById('result-sub').textContent = 'Fetching from: ' + SCRIPT_URL.substring(0, 60) + '...';

  loadPollOnly();
}

async function loadPollOnly() {
  const container = document.getElementById('poll-cards');

  if (!SCRIPT_URL || SCRIPT_URL.trim() === '') {
    container.innerHTML = '<div class="poll-error">‚ùå No Script URL found.</div>';
    document.getElementById('poll-voters').textContent = 'Not connected';
    document.getElementById('r-total').textContent = '‚Äî';
    document.getElementById('t-total').textContent = '‚Äî';
    return;
  }

  container.innerHTML = '<div class="poll-loading"><div class="spinner"></div> Fetching guest responses...</div>';

  try {
    const data = await jsonpFetch(SCRIPT_URL);
    // Clear debug subtitle
    document.getElementById('result-sub').textContent = 'Results update as more guests complete the quiz.';
    renderPoll(data, true);
  } catch(e) {
    console.warn('Poll load failed:', e);
    container.innerHTML =
      '<div class="poll-error">‚ö†Ô∏è Failed: ' + e.message + '<br><small>URL: ' + SCRIPT_URL.substring(0,80) + '</small><br><br>' +
      '<button onclick="loadPollOnly()" style="margin-top:.5rem;padding:.5rem 1.2rem;border-radius:50px;border:1.5px solid #e8a598;background:transparent;color:#e8a598;cursor:pointer;font-family:Jost,sans-serif">Retry</button></div>';
  }
}

function shareResult() {
  const winner = rScore>tScore?'Rutuja':tScore>rScore?'Tanmay':'Both equally';
  const text = 'üçº Rutuja & Tanmay Baby Shower Quiz\n'+playerName+"'s votes:\n‚Ä¢ Rutuja: "+rScore+'/10\n‚Ä¢ Tanmay: '+tScore+'/10\nüèÜ MVP parent pick: '+winner+'!';
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => alert('Copied! Share with the group üíå'));
  } else { alert(text); }
}
</script>
</body>
</html>
